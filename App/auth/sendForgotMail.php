<?php
require "../connection/conn.php";
$email = $_GET['mail'];
$mail->addAddress($email, "VFA");

// Checking that Email is Registered with VFA and it was verified or not 

$sql = "SELECT * FROM `farmer` WHERE `email` = '$email'";
$result  = mysqli_query($con, $sql);
if (mysqli_num_rows($result) == 0) {
    echo "This Email was not Registered with VFA";
    exit;
}
if ($result) {
    while ($row = mysqli_fetch_assoc($result)) {

        if ($row['email-status'] == 'verified') {
            $hash = $row['mail_hash'];
            $user = $row['username'];
            $msg = "<!DOCTYPE html> <html lang='en' xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:v='urn:schemas-microsoft-com:vml'> <head> <title></title> <meta content='text/html; charset=utf-8' http-equiv='Content-Type' /> <meta content='width=device-width,initial-scale=1' name='viewport' /> <!--[if mso]><xml><o:OfficeDocumentSettings><o:PixelsPerInch>96</o:PixelsPerInch><o:AllowPNG/></o:OfficeDocumentSettings></xml><![endif]--> <!--[if !mso]><!--> <link href='https://fonts.googleapis.com/css?family=Cabin' rel='stylesheet' type='text/css' /> <link href='https://fonts.googleapis.com/css?family=Montserrat' rel='stylesheet' type='text/css' /> <!--<![endif]--> <style> * { box-sizing: border-box } body { margin: 0; padding: 0 } a[x-apple-data-detectors] { color: inherit !important; text-decoration: inherit !important } #MessageViewBody a { color: inherit; text-decoration: none } p { line-height: inherit } .desktop_hide, .desktop_hide table { mso-hide: all; display: none; max-height: 0; overflow: hidden } @media (max-width:670px) { .desktop_hide table.icons-inner { display: inline-block !important } .icons-inner { text-align: center } .icons-inner td { margin: 0 auto } .image_block img.big, .row-content { width: 100% !important } .mobile_hide { display: none } .stack .column { width: 100%; display: block } .mobile_hide { min-height: 0; max-height: 0; max-width: 0; overflow: hidden; font-size: 0 } .desktop_hide, .desktop_hide table { display: table !important; max-height: none !important } } </style> </head> <body style='background-color:#000;margin:0;padding:0;-webkit-text-size-adjust:none;text-size-adjust:none'> <table border='0' cellpadding='0' cellspacing='0' class='nl-container' role='presentation' style='mso-table-lspace:0;mso-table-rspace:0;background-color:#000' width='100%'> <tbody> <tr> <td> <table align='center' border='0' cellpadding='0' cellspacing='0' class='row row-1' role='presentation' style='mso-table-lspace:0;mso-table-rspace:0;background-color:#f3e6f8' width='100%'> <tbody> <tr> <td> <table align='center' border='0' cellpadding='0' cellspacing='0' class='row-content stack' role='presentation' style='mso-table-lspace:0;mso-table-rspace:0;background-color:#fff;background-image:url(https://i.postimg.cc/sxr7cxSN/Reset-Password-BG-2.png);background-position:center top;background-repeat:no-repeat;color:#000;width:650px' width='650'> <tbody> <tr> <td class='column column-1' style='mso-table-lspace:0;mso-table-rspace:0;font-weight:400;text-align:left;vertical-align:top;padding-top:45px;padding-bottom:0;border-top:0;border-right:0;border-bottom:0;border-left:0' width='100%'> <table border='0' cellpadding='20' cellspacing='0' class='divider_block' role='presentation' style='mso-table-lspace:0;mso-table-rspace:0' width='100%'> <tr> <td> <div align='center'> <table border='0' cellpadding='0' cellspacing='0' role='presentation' style='mso-table-lspace:0;mso-table-rspace:0' width='100%'> <tr> <td class='divider_inner' style='font-size:1px;line-height:1px;border-top:0 solid #bbb'> <span> </span></td> </tr> </table> </div> </td> </tr> </table> <table border='0' cellpadding='20' cellspacing='0' class='image_block' role='presentation' style='mso-table-lspace:0;mso-table-rspace:0' width='100%'> <tr> <td> <div align='center' style='line-height:10px'><img alt='Forgot your password?' class='big' src='https://i.postimg.cc/hjxVTTJm/lock5.png' style='display:block;height:auto;border:0;width:358px;max-width:100%' title='Forgot your password?' width='358' /> </div> </td> </tr> </table> <table border='0' cellpadding='0' cellspacing='0' class='heading_block' role='presentation' style='mso-table-lspace:0;mso-table-rspace:0' width='100%'> <tr> <td style='padding-top:35px;text-align:center;width:100%'> <h1 style='margin:0;color:#8412c0;direction:ltr;font-family:Cabin,Arial,'Helvetica Neue',Helvetica,sans-serif;font-size:28px;font-weight:400;letter-spacing:normal;line-height:120%;text-align:center;margin-top:0;margin-bottom:0'> <strong>Forgot your password?</strong></h1> </td> </tr> </table> <table border='0' cellpadding='0' cellspacing='0' class='text_block' role='presentation' style='mso-table-lspace:0;mso-table-rspace:0;word-break:break-word' width='100%'> <tr> <td style='padding-left:45px;padding-right:45px;padding-top:10px'> <div style='font-family:Arial,sans-serif'> <div class='txtTinyMce-wrapper' style='font-size:12px;font-family:Cabin,Arial,'Helvetica Neue',Helvetica,sans-serif;mso-line-height-alt:18px;color:#393d47;line-height:1.5'> <p style='margin:0;text-align:center;mso-line-height-alt:27px'> <span style='font-size:18px;color:#aa67cf;'>We received a request to reset your password.</span></p> <p style='margin:0;text-align:center;mso-line-height-alt:27px'> <span style='font-size:18px;color:#aa67cf;'>If you didn't make this request, simply ignore this email.</span></p> </div> </div> </td> </tr> </table> <table border='0' cellpadding='20' cellspacing='0' class='divider_block' role='presentation' style='mso-table-lspace:0;mso-table-rspace:0' width='100%'> <tr> <td> <div align='center'> <table border='0' cellpadding='0' cellspacing='0' role='presentation' style='mso-table-lspace:0;mso-table-rspace:0' width='80%'> <tr> <td class='divider_inner' style='font-size:1px;line-height:1px;border-top:1px solid #e1b4fc'> <span> </span></td> </tr> </table> </div> </td> </tr> </table> <table border='0' cellpadding='0' cellspacing='0' class='text_block' role='presentation' style='mso-table-lspace:0;mso-table-rspace:0;word-break:break-word' width='100%'> <tr> <td style='padding-bottom:10px;padding-left:45px;padding-right:45px;padding-top:10px'> <div style='font-family:Arial,sans-serif'> <div class='txtTinyMce-wrapper' style='font-size:12px;font-family:Cabin,Arial,'Helvetica Neue',Helvetica,sans-serif;text-align:center;mso-line-height-alt:18px;color:#393d47;line-height:1.5'> <p style='margin:0;mso-line-height-alt:19.5px'> <span style='font-size:13px;color:#8412c0;'>If you did make this request just click the button below:</span></p> </div> </div> </td> </tr> </table> <table border='0' cellpadding='10' cellspacing='0' class='button_block' role='presentation' style='mso-table-lspace:0;mso-table-rspace:0' width='100%'> <tr> <td> <div align='center'> <!--[if mso]><v:roundrect xmlns:v='urn:schemas-microsoft-com:vml' xmlns:w='urn:schemas-microsoft-com:office:word' href='http://www.example.com' style='height:54px;width:239px;v-text-anchor:middle;' arcsize='0%' strokeweight='0.75pt' strokecolor='#8412c0' fillcolor='#8412c0'><w:anchorlock/><v:textbox inset='0px,0px,0px,0px'><center style='color:#ffffff; font-family:Arial, sans-serif; font-size:14px'><![endif]--> <a href='" . $base . "/App/auth/resetPassword.php?hash=" . $hash . "&user=" . $user . "' style='text-decoration:none;display:inline-block;color:#ffffff;background-color:#8412c0;border-radius:0px;width:auto;border-top:1px solid #8412c0;font-weight:400;border-right:1px solid #8412c0;border-bottom:1px solid #8412c0;border-left:1px solid #8412c0;padding-top:10px;padding-bottom:10px;font-family:'Cabin', Arial, 'Helvetica Neue', Helvetica, sans-serif;text-align:center;mso-border-alt:none;word-break:keep-all;' target='_blank'><span style='padding-left:40px;padding-right:40px;font-size:14px;display:inline-block;letter-spacing:normal;'><span style='font-size: 16px; line-height: 2; word-break: break-word; mso-line-height-alt: 32px;'><span data-mce-style='font-size: 14px; line-height: 28px;' style='font-size: 14px; line-height: 28px;'>RESET MY PASSWORD</span></span></span></a> <!--[if mso]></center></v:textbox></v:roundrect><![endif]--> </div> </td> </tr> </table> <table border='0' cellpadding='0' cellspacing='0' class='text_block' role='presentation' style='mso-table-lspace:0;mso-table-rspace:0;word-break:break-word' width='100%'> <tr> <td style='padding-bottom:15px;padding-left:10px;padding-right:10px;padding-top:10px'> <div style='font-family:Arial,sans-serif'> <div class='txtTinyMce-wrapper' style='font-size:12px;font-family:Cabin,Arial,'Helvetica Neue',Helvetica,sans-serif;mso-line-height-alt:14.399999999999999px;color:#393d47;line-height:1.2'> <p style='margin:0;font-size:14px;text-align:center'> <span style='font-size:10px;color:#aa67cf;'><span style=''>If you didn't request to change your brand password, </span><span style=''>you don't have to do anything. So that's easy.</span></span></p> </div> </div> </td> </tr> </table> </td> </tr> </tbody> </table> </td> </tr> </tbody> </table> <table align='center' border='0' cellpadding='0' cellspacing='0' class='row row-2' role='presentation' style='mso-table-lspace:0;mso-table-rspace:0;background-color:#f3e6f8' width='100%'> <tbody> <tr> <td> <table align='center' border='0' cellpadding='0' cellspacing='0' class='row-content stack' role='presentation' style='mso-table-lspace:0;mso-table-rspace:0;color:#000;width:650px' width='650'> <tbody> <tr> <td class='column column-1' style='mso-table-lspace:0;mso-table-rspace:0;font-weight:400;text-align:left;vertical-align:top;padding-top:5px;padding-bottom:10px;border-top:0;border-right:0;border-bottom:0;border-left:0' width='100%'> <table border='0' cellpadding='5' cellspacing='0' class='divider_block' role='presentation' style='mso-table-lspace:0;mso-table-rspace:0' width='100%'> <tr> <td> <div align='center'> <table border='0' cellpadding='0' cellspacing='0' role='presentation' style='mso-table-lspace:0;mso-table-rspace:0' width='100%'> <tr> <td class='divider_inner' style='font-size:1px;line-height:1px;border-top:0 solid #bbb'> <span> </span></td> </tr> </table> </div> </td> </tr> </table> </td> </tr> </tbody> </table> </td> </tr> </tbody> </table> <table align='center' border='0' cellpadding='0' cellspacing='0' class='row row-3' role='presentation' style='mso-table-lspace:0;mso-table-rspace:0' width='100%'> <tbody> <tr> <td> <table align='center' border='0' cellpadding='0' cellspacing='0' class='row-content stack' role='presentation' style='mso-table-lspace:0;mso-table-rspace:0;color:#000;width:650px' width='650'> <tbody> <tr> <td class='column column-1' style='mso-table-lspace:0;mso-table-rspace:0;font-weight:400;text-align:left;vertical-align:top;padding-top:5px;padding-bottom:5px;border-top:0;border-right:0;border-bottom:0;border-left:0' width='100%'> </td> </tr> </tbody> </table> </td> </tr> </tbody> </table> </td> </tr> </tbody> </table> </body> </html>";

            $mail->Subject = "Your new password is just a few clicks away";
            // $mail->MsgHTML = "$msg";

            $mail->Body = $msg;
            $mail->AltBody = "<a href='" . $base . "App/auth/resetPassword.php?hash=" . $hash . "&user=" . $user . "' style='text-decoration:none;display:inline-block;color:#ffffff;background-color:#8412c0;border-radius:0px;width:auto;border-top:1px solid #8412c0;font-weight:400;border-right:1px solid #8412c0;border-bottom:1px solid #8412c0;border-left:1px solid #8412c0;padding-top:10px;padding-bottom:10px;font-family:'Cabin', Arial, 'Helvetica Neue', Helvetica, sans-serif;text-align:center;mso-border-alt:none;word-break:keep-all;' target='_blank'><span style='padding-left:40px;padding-right:40px;font-size:14px;display:inline-block;letter-spacing:normal;'><span style='font-size: 16px; line-height: 2; word-break: break-word; mso-line-height-alt: 32px;'><span data-mce-style='font-size: 14px; line-height: 28px;' style='font-size: 14px; line-height: 28px;'>RESET MY PASSWORD</span></span></span></a>";

            try {
                $mail->send();
                echo "Password Reset link has been sent successfully :)";
            } catch (Exception $e) {
                echo "Exception : " . $e->getMessage();
            }
        } else {
            echo "Your Email Was Not verified Please Verify it First to Reset your Password \n or Create a new Account";
        }
    }
} else {
    echo "Query Failed: ".mysqli_error($con);
}
?>